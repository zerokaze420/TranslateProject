name: Check Article Validity

on:
  pull_request:
    branches:
      - master
    paths:
      # ç¡®ä¿åªæœ‰ sources/ ç›®å½•ä¸‹çš„ .md æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶æ‰è§¦å‘
      - 'sources/**.md'

jobs:
  check-article:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch all history for accurate diffing
          fetch-depth: 0 
          
      - name: Install yq
        # å®‰è£… yqï¼Œå®ƒæ˜¯å¤„ç† YAML front matter çš„å…³é”®å·¥å…·
        run: sudo snap install yq
          
      - name: Get Diff
        id: git-diff-action
        # è·å– PR ä¸­æ›´æ”¹çš„æ–‡ä»¶åˆ—è¡¨ï¼Œå¹¶è¾“å‡ºåˆ° diff.json
        uses: GrantBirki/git-diff-action@v2.7.0
        with:
          json_diff_file_output: diff.json
          file_output_only: true
          
      - name: Run Article Checks
        # å°†ç¯å¢ƒå˜é‡ï¼ˆDiff æ–‡ä»¶è·¯å¾„å’Œ PR å¼€å¯è€… IDï¼‰ä¼ é€’ç»™è„šæœ¬
        env:
          DIFF_JSON: ${{ steps.git-diff-action.outputs.json-diff-path }}
          ACTOR_ID: ${{ github.actor }}
          
        run: |
          #!/bin/bash
          
          # é‡åˆ°ä»»ä½•é”™è¯¯ç«‹å³é€€å‡º
          set -e 
          
          # å®šä¹‰ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œç”¨äºä»æ–‡ä»¶çš„ YAML front matter ä¸­æå–å€¼
          # æ›¿ä»£åŸè„šæœ¬ä¸­çš„ 'yq -f extract'
          yq_extract() {
            local KEY="$1"
            local FILE="$2"
            # ä½¿ç”¨ yq å‘½ä»¤æå–å€¼ã€‚
            # sed ç”¨äºå»é™¤ yq è¾“å‡ºä¸­å¯èƒ½å¸¦æœ‰çš„å¼•å·ã€‚
            yq e ".$KEY" "$FILE" | sed 's/^"//;s/"$//'
          }
          

          
          # æ£€æŸ¥æ–‡ä»¶åæ ¼å¼æ˜¯å¦æœ‰æ•ˆï¼ˆä»…å°å†™å­—æ¯ã€æ•°å­—å’Œè¿å­—ç¬¦ï¼‰
          check_filename_format() {
            local ARTICLE_PATH="$1"
            FILENAME=$(basename "$ARTICLE_PATH" .md)
            if [[ ! "$FILENAME" =~ ^[a-z0-9]+(-[a-z0-9]+)*$ ]]; then
              ERROR=$ERROR"Invalid filename format. Filename should only contain lowercase letters, numbers, and hyphens; "
            fi
          }
          
          # æ£€æŸ¥ published_date å’Œ publisher
          check_published() {
            local PUBLISHED_ARTICLE="$1"
            PUBLISHER=$(yq_extract 'publisher' $PUBLISHED_ARTICLE)
            PUBLISHED_DATE=$(yq_extract 'published_date' $PUBLISHED_ARTICLE)
            
            if [ "$PUBLISHER" == "null" ] || [ "$PUBLISHED_DATE" == "null" ]; then
              ERROR=$ERROR"Missing metadata in publisher/published_date; "
            fi
          }
          
          # æ£€æŸ¥ proofread_date
          check_proofread() {
            local PROOFREAD_ARTICLE="$1"
            PROOFREAD_DATE=$(yq_extract 'proofread_date' $PROOFREAD_ARTICLE)
            
            if [ "$PROOFREAD_DATE" == "null" ]; then
              ERROR=$ERROR"Missing metadata in proofread_date; "
            else
              # æ£€æŸ¥ proofread_date æ˜¯å¦æ—©äº published_date
              PUBLISHED_DATE=$(yq_extract 'published_date' $PROOFREAD_ARTICLE)
              if [ ! "$PUBLISHED_DATE" == "null" ] && [ "$PUBLISHED_DATE" -lt "$PROOFREAD_DATE" ]; then
                ERROR=$ERROR"Published date is earlier than proofread date; "
              fi
            fi
          }
          
          # æ£€æŸ¥ proofreader
          check_proofreading() {
            local PROOFREADING_ARTICLE="$1"
            PROOFREADER=$(yq_extract 'proofreader' $PROOFREADING_ARTICLE)
            
            if [ "$PROOFREADER" == "null" ]; then
              ERROR=$ERROR"Missing metadata in proofreader; "
            else
              if [ "$STATUS" == "proofreading" ] || [ "$STATUS" == "proofread" ]; then
                if [ "$PROOFREADER" != "$ACTOR_ID" ]; then
                  ERROR=$ERROR"Proofreader is not the same as the PR opener; "
                fi
              fi
            fi
          }
          
          # æ£€æŸ¥ translated_date
          check_translated() {
            local TRANSLATED_ARTICLE="$1"
            TRANSLATED_DATE=$(yq_extract 'translated_date' $TRANSLATED_ARTICLE)
            
            if [ "$TRANSLATED_DATE" == "null" ]; then
              ERROR=$ERROR"Missing metadata in translated_date; "
            else
              # æ£€æŸ¥ translated_date æ˜¯å¦æ—©äº proofread_date
              PROOFREAD_DATE=$(yq_extract 'proofread_date' $TRANSLATED_ARTICLE)
              if [ ! "$PROOFREAD_DATE" == "null" ] && [ "$PROOFREAD_DATE" -lt "$TRANSLATED_DATE" ]; then
                ERROR=$ERROR"Proofread date is earlier than translated date; "
              fi
            fi
          }
          
          # æ£€æŸ¥ translator
          check_translating() {
            local TRANSLATING_ARTICLE="$1"
            TRANSLATOR=$(yq_extract 'translator' $TRANSLATING_ARTICLE)
            TRANSLATING_DATE=$(yq_extract 'translating_date' $TRANSLATING_ARTICLE)
            
            if [ "$TRANSLATOR" == "null" ]; then
              ERROR=$ERROR"Missing metadata in translator; "
            else
              if [ "$STATUS" == "translating" ] || [ "$STATUS" == "translated" ]; then
                COLLECTED_DATE=$(yq_extract 'collected_date' $TRANSLATING_ARTICLE)
                if [ ! "$TRANSLATING_DATE" == "null" ] && [ "$TRANSLATING_DATE" -lt "$COLLECTED_DATE" ]; then
                  ERROR=$ERROR"Translating date is earlier than collected date;"
                elif [ "$TRANSLATOR" != "$ACTOR_ID" ]; then
                  ERROR=$ERROR"Translator is not the same as the PR opener; "
                fi
              fi
            fi
          }
          
          # æ£€æŸ¥æ”¶é›†é˜¶æ®µçš„å…ƒæ•°æ®
          check_collected() {
            local COLLECTED_ARTICLE="$1"
            TITLE=$(yq_extract 'title' $COLLECTED_ARTICLE)
            AUTHOR=$(yq_extract 'author' $COLLECTED_ARTICLE)
            COLLECTOR=$(yq_extract 'collector' $COLLECTED_ARTICLE)
            COLLECTED_DATE=$(yq_extract 'collected_date' $COLLECTED_ARTICLE)
            LINK=$(yq_extract 'link' $COLLECTED_ARTICLE)
            
            if [ "$TITLE" == "null" ] || [ "$AUTHOR" == "null" ] || [ "$COLLECTOR" == "null" ] || [ "$COLLECTED_DATE" == "null" ] || [ "$LINK" == "null" ]; then
              ERROR=$ERROR"Missing metadata in title/author/collector/collected_date/link; "
            else
              # æ£€æŸ¥ collected_date æ˜¯å¦æ—©äº translated_date
              TRANSLATED_DATE=$(yq_extract 'translated_date' $COLLECTED_ARTICLE)
              if [ ! "$TRANSLATED_DATE" == "null" ] && [ "$TRANSLATED_DATE" -lt "$COLLECTED_DATE" ]; then
                ERROR=$ERROR"Translated date is earlier than collected date; "
              fi
              if [ "$STATUS" == "collected" ]; then
                if [ "$COLLECTOR" != "$ACTOR_ID" ]; then
                  ERROR=$ERROR"Collector is not the same as the PR opener; "
                fi
              fi
            fi
          }
          
          CHECK_PASSED=1 # To check if all the articles pass
          echo $DIFF_JSON
          
          for ARTICLE in $FILES; do
            echo "Checking article: $ARTICLE"
            ERROR=""
            # Add the new filename format check
            check_filename_format $ARTICLE
          
            STATUS=$(yq_extract 'status' $ARTICLE)
            
            case $STATUS in
              "published")
                check_published $ARTICLE
                ;& # Fallthrough to ensure low stage checks will run on articles in higher stages
              "proofread")
                check_proofread $ARTICLE
                ;&
              "proofreading")
                check_proofreading $ARTICLE
                ;&
              "translated")
                check_translated $ARTICLE
                ;&
              "translating")
                check_translating $ARTICLE
                ;&
              "collected")
                check_collected $ARTICLE
                ;;
              *)
                ERROR=$ERROR"Invalid status: $STATUS"
                ;;
            esac
            
            # Printlog for each article
            if [ -z "$ERROR" ]; then
              echo "  âœ¨ All checks passed for $STATUS $ARTICLE"
            else
              echo "  ğŸ˜­ Some checks failed for $STATUS $ARTICLE: $ERROR"
              CHECK_PASSED=0
            fi
          done
          
          # Print overall result
          if [ $CHECK_PASSED -eq 0 ]; then
            echo "âŒ Some checks failed. Please fix the article(s) before merging the PR."
            exit 1
          else
            echo "âœ… All checks passed. You can merge the PR now."
            exit 0
          fi
