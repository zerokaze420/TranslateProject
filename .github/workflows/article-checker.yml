name: Check Article Validity

on:
  pull_request:
    branches:
      - master
    paths:
      - 'sources/**.md'

jobs:
  check-article:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch all history for accurate diffing
          fetch-depth: 0 
          
      - name: Install yq
        run: |
          # Install yq - a lightweight and portable command-line YAML processor
          sudo snap install yq
          
      # âš ï¸ æ³¨æ„: ç”±äºä½ åœ¨è„šæœ¬ä¸­ä½¿ç”¨äº† `yq -f extract ...`ï¼Œ
      # æˆ‘å‡è®¾ä½ éœ€è¦ä¸€ä¸ªåä¸º `extract` çš„è„šæœ¬æˆ–å‡½æ•°æ¥æå– front matterã€‚
      # ä¸ºç®€åŒ–ï¼Œæˆ‘å°†æ•´ä¸ª check é€»è¾‘æ”¾åœ¨ä¸€ä¸ª run å—ä¸­ï¼Œå¹¶åœ¨å¼€å¤´å®šä¹‰ä¸€ä¸ª
      # è¾…åŠ©å‡½æ•°æ¥æå– YAML front matter å€¼ï¼Œä»£æ›¿ä½ çš„ `yq -f extract`ã€‚

      - name: Get Diff
        id: git-diff-action
        # This action generates a JSON file with diff details
        uses: GrantBirki/git-diff-action@v2.7.0
        with:
          json_diff_file_output: diff.json
          file_output_only: true
          
      - name: Run Article Checks
        env:
          DIFF_JSON: ${{ steps.git-diff-action.outputs.json-diff-path }}
          ACTOR_ID: ${{ github.actor }}
          
        run: |
          #!/bin/bash
          
          set -e 
          
          # ğŸš¨ æ¨¡æ‹Ÿä½ çš„ `yq -f extract .key` è¡Œä¸º
          # å› ä¸º GitHub Runner ä¸­é»˜è®¤æ²¡æœ‰è¿™ä¸ªæå–è„šæœ¬ã€‚
          # è¿™é‡Œå®šä¹‰ä¸€ä¸ª Bash å‡½æ•°æ¥ä» YAML front matter ä¸­æå–å€¼ã€‚
          # å®ƒä¼šæŸ¥æ‰¾ä»¥ `key: ` å¼€å¤´çš„è¡Œã€‚
          yq_extract() {
            local KEY="$1"
            local FILE="$2"
            # ä½¿ç”¨ grep/sed/awk æå– YAML front matter ä¸­çš„å€¼
            # è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„å®ç°ï¼Œå‡è®¾ front matter æ ¼å¼ç®€å•ã€‚
            # æ›´å¥å£®çš„æ–¹å¼æ˜¯å®‰è£… yq æˆ–å…¶ä»– YAML è§£æå·¥å…·ã€‚
            
            # ä½¿ç”¨ yq å‘½ä»¤ï¼ˆå‡è®¾å·²å®‰è£…ï¼‰
            # `yq e` æ˜¯ `yq` çš„æ ‡å‡†ç”¨æ³•
            yq e ".$KEY" "$FILE" | sed 's/^"//;s/"$//'
          }
          
          # Get valid files in git diff (markdown files in sources/)
          get_diff_article_files() {
            # è¿™é‡Œçš„ yq å‘½ä»¤éœ€è¦è§£æ GrantBirki/git-diff-action çš„è¾“å‡º JSON
            ARTICLES=$(yq e '.files[].path | select(. | endswith(".md"))' $DIFF_JSON)
            
            if [ -z "$ARTICLES" ]; then
              echo "No valid articles found in the PR. Skip checks."
              exit 0
            fi
            # ç§»é™¤å‰é¢å®šä¹‰çš„ ARTICLES å˜é‡ï¼Œç”¨æ–°çš„ FILES å˜é‡ä»£æ›¿
            # ç¡®ä¿ FILES åœ¨å…¨å±€å¯ç”¨
            FILES="$ARTICLES"
          }
          
          # Check if filename format is valid (lower case letters and hyphens only)
          check_filename_format() {
            local ARTICLE_PATH="$1"
            FILENAME=$(basename "$ARTICLE_PATH" .md)
            if [[ ! "$FILENAME" =~ ^[a-z0-9]+(-[a-z0-9]+)*$ ]]; then
              ERROR=$ERROR"Invalid filename format. Filename should only contain lowercase letters, numbers, and hyphens; "
            fi
          }
          
          # Check if published_date is in the front matter
          check_published() {
            local PUBLISHED_ARTICLE="$1"
            PUBLISHER=$(yq_extract 'publisher' $PUBLISHED_ARTICLE)
            PUBLISHED_DATE=$(yq_extract 'published_date' $PUBLISHED_ARTICLE)
            
            if [ "$PUBLISHER" == "null" ] || [ "$PUBLISHED_DATE" == "null" ]; then
              ERROR=$ERROR"Missing metadata in publisher/published_date; "
            # Comment this check since it's good to give a last chance for people
            # to fix some minor issues missed in the previous stages
            # else
            #    # No stage check needed for the final stage
            #    if [ "$PUBLISHER" != "$ACTOR_ID" ]; then
            #       ERROR=$ERROR"Publisher is not the same as the PR opener; "
            #    fi
            fi
          }
          
          # Check if proofread_date is in the front matter
          check_proofread() {
            local PROOFREAD_ARTICLE="$1"
            PROOFREAD_DATE=$(yq_extract 'proofread_date' $PROOFREAD_ARTICLE)
            
            if [ "$PROOFREAD_DATE" == "null" ]; then
              ERROR=$ERROR"Missing metadata in proofread_date; "
            else
              # Check if proofread_date is earlier than published_date
              PUBLISHED_DATE=$(yq_extract 'published_date' $PROOFREAD_ARTICLE)
              # æ³¨æ„: å‡è®¾æ—¥æœŸæ ¼å¼æ˜¯å¯æ¯”è¾ƒçš„æ•´æ•°æˆ– YYYYMMDD æ ¼å¼
              if [ ! "$PUBLISHED_DATE" == "null" ] && [ "$PUBLISHED_DATE" -lt "$PROOFREAD_DATE" ]; then
                ERROR=$ERROR"Published date is earlier than proofread date; "
              fi
            fi
          }
          
          # Check if proofreader is in the front matter for proofreading/proofread stage,
          # and check if proofreader is the same as the PR opener in proofreading/proofread stage
          check_proofreading() {
            local PROOFREADING_ARTICLE="$1"
            PROOFREADER=$(yq_extract 'proofreader' $PROOFREADING_ARTICLE)
            
            if [ "$PROOFREADER" == "null" ]; then
              ERROR=$ERROR"Missing metadata in proofreader; "
            else
              if [ "$STATUS" == "proofreading" ] || [ "$STATUS" == "proofread" ]; then
                if [ "$PROOFREADER" != "$ACTOR_ID" ]; then
                  ERROR=$ERROR"Proofreader is not the same as the PR opener; "
                fi
              fi
            fi
          }
          
          # Check if translated_date is in the front matter
          check_translated() {
            local TRANSLATED_ARTICLE="$1"
            TRANSLATED_DATE=$(yq_extract 'translated_date' $TRANSLATED_ARTICLE)
            
            if [ "$TRANSLATED_DATE" == "null" ]; then
              ERROR=$ERROR"Missing metadata in translated_date; "
            else
              # Check if translated_date is earlier than proofread_date
              PROOFREAD_DATE=$(yq_extract 'proofread_date' $TRANSLATED_ARTICLE)
              if [ ! "$PROOFREAD_DATE" == "null" ] && [ "$PROOFREAD_DATE" -lt "$TRANSLATED_DATE" ]; then
                ERROR=$ERROR"Proofread date is earlier than translated date; "
              fi
            fi
          }
          
          # Check if translator is in the front matter for translating/translated stage,
          # and check if translator is the same as the PR opener in translating/translated stage
          check_translating() {
            local TRANSLATING_ARTICLE="$1"
            TRANSLATOR=$(yq_extract 'translator' $TRANSLATING_ARTICLE)
            TRANSLATING_DATE=$(yq_extract 'translating_date' $TRANSLATING_ARTICLE)
            
            if [ "$TRANSLATOR" == "null" ]; then
              ERROR=$ERROR"Missing metadata in translator; "
            else
              if [ "$STATUS" == "translating" ] || [ "$STATUS" == "translated" ]; then
                COLLECTED_DATE=$(yq_extract 'collected_date' $TRANSLATING_ARTICLE)
                if [ ! "$TRANSLATING_DATE" == "null" ] && [ "$TRANSLATING_DATE" -lt "$COLLECTED_DATE" ]; then
                  ERROR=$ERROR"Translating date is earlier than collected date;"
                elif [ "$TRANSLATOR" != "$ACTOR_ID" ]; then
                  ERROR=$ERROR"Translator is not the same as the PR opener; "
                fi
              fi
            fi
          }
          
          # Check if collected_date, collector, title, and author are in the front matter,
          # and check if collector is the same as the PR opener in collected stage
          check_collected() {
            local COLLECTED_ARTICLE="$1"
            TITLE=$(yq_extract 'title' $COLLECTED_ARTICLE)
            AUTHOR=$(yq_extract 'author' $COLLECTED_ARTICLE)
            COLLECTOR=$(yq_extract 'collector' $COLLECTED_ARTICLE)
            COLLECTED_DATE=$(yq_extract 'collected_date' $COLLECTED_ARTICLE)
            LINK=$(yq_extract 'link' $COLLECTED_ARTICLE)
            
            if [ "$TITLE" == "null" ] || [ "$AUTHOR" == "null" ] || [ "$COLLECTOR" == "null" ] || [ "$COLLECTED_DATE" == "null" ] || [ "$LINK" == "null" ]; then
              ERROR=$ERROR"Missing metadata in title/author/collector/collected_date/link; "
            else
              # Check if collected_date is earlier than translated_date
              TRANSLATED_DATE=$(yq_extract 'translated_date' $COLLECTED_ARTICLE)
              if [ ! "$TRANSLATED_DATE" == "null" ] && [ "$TRANSLATED_DATE" -lt "$COLLECTED_DATE" ]; then
                ERROR=$ERROR"Translated date is earlier than collected date; "
              fi
              if [ "$STATUS" == "collected" ]; then
                if [ "$COLLECTOR" != "$ACTOR_ID" ]; then
                  ERROR=$ERROR"Collector is not the same as the PR opener; "
                fi
              fi
            fi
          }
          
          CHECK_PASSED=1 # To check if all the articles pass
          get_diff_article_files
          
          # ä½¿ç”¨ FILES å˜é‡ï¼Œè€Œä¸æ˜¯æ—§çš„ ARTICLES å˜é‡
          for ARTICLE in $FILES; do
            echo "Checking article: $ARTICLE"
            ERROR=""
            # Add the new filename format check
            check_filename_format $ARTICLE
          
            STATUS=$(yq_extract 'status' $ARTICLE)
            
            case $STATUS in
              "published")
                check_published $ARTICLE
                ;& # Fallthrough to ensure low stage checks will run on articles in higher stages
              "proofread")
                check_proofread $ARTICLE
                ;&
              "proofreading")
                check_proofreading $ARTICLE
                ;&
              "translated")
                check_translated $ARTICLE
                ;&
              "translating")
                check_translating $ARTICLE
                ;&
              "collected")
                check_collected $ARTICLE
                ;;
              *)
                ERROR=$ERROR"Invalid status: $STATUS"
                ;;
            esac
            
            # Printlog for each article
            if [ -z "$ERROR" ]; then
              echo "  âœ¨ All checks passed for $STATUS $ARTICLE"
            else
              echo "  ğŸ˜­ Some checks failed for $STATUS $ARTICLE: $ERROR"
              CHECK_PASSED=0
            fi
          done
          
          # Print overall result
          if [ $CHECK_PASSED -eq 0 ]; then
            echo "âŒ Some checks failed. Please fix the article(s) before merging the PR."
            exit 1
          else
            echo "âœ… All checks passed. You can merge the PR now."
            exit 0
          fi
