name: Check PRs for Modified Markdown Files

on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:

permissions:
  pull-requests: read
  contents: read

jobs:
  check-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: List open pull requests
        id: list_prs
        run: |
          PRS=$(gh api --paginate \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/pulls?state=open&per_page=100" \
            --jq '.[].number')
          if [ -z "$PRS" ]; then
            echo "No open PRs found."
            echo "prs=" >> $GITHUB_OUTPUT
          else
            echo "Found PRs: $PRS"
            echo "prs=$PRS" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install yq (direct download)
        run: |
          wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Verify yq installation
        run: |
          yq --version

      - name: Process each PR and send Feishu alert if needed
        if: ${{ steps.list_prs.outputs.prs != '' }}
        run: |
          IFS=$'\n'

          for pr_number in ${{ steps.list_prs.outputs.prs }}; do
            echo "=== Checking PR #$pr_number ==="

            # ğŸŒŸ è·å– PR çš„å®Œæ•´ URL
            PR_URL=$(gh api "/repos/${{ github.repository }}/pulls/$pr_number" --jq '.html_url')
            if [ -z "$PR_URL" ]; then
              PR_URL="https://github.com/${{ github.repository }}/pull/$pr_number"
            fi

            BASE_REF=$(gh api "/repos/${{ github.repository }}/pulls/$pr_number" --jq '.base.ref')
            echo "Base branch: $BASE_REF"

            # è·å– PR åˆå¹¶é¢„è§ˆ
            git fetch origin "pull/$pr_number/merge:pr_merge_$pr_number" 2>/dev/null || {
              echo "âš ï¸ æ— æ³•è·å– PR åˆå¹¶é¢„è§ˆï¼Œå¯èƒ½å†²çªæˆ–å°šæœªå‡†å¤‡å¥½ã€‚è·³è¿‡æ­¤ PRã€‚"
              continue
            }
            git checkout pr_merge_$pr_number

            # æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº† sources/**/*.md
            CHANGED_MD_FILES=$(git diff --name-only "origin/$BASE_REF..HEAD" -- 'sources/**/*.md' 2>/dev/null)
            if [ -z "$CHANGED_MD_FILES" ]; then
              echo "âŒ PR #$pr_number æœªä¿®æ”¹ sources/**/*.md æ–‡ä»¶"
              echo "------------------------------"
              continue
            fi

            echo "âœ… PR #$pr_number ä¿®æ”¹äº†ä»¥ä¸‹ Markdown æ–‡ä»¶ï¼š"
            echo "$CHANGED_MD_FILES"

            # ç”¨äºæ”¶é›†å½“å‰ PR ä¸­æ‰€æœ‰è¶…æœŸæ–‡ä»¶ï¼ˆJSON æ•°ç»„æ ¼å¼ï¼‰
            JSON_LIST="["

            HAS_ERROR=false
            FIRST_ITEM=true

            while IFS= read -r file; do
              if [ ! -f "$file" ]; then
                echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨: $file"
                continue
              fi

              # æå– YAML Front Matter (--- åˆ° --- ä¹‹é—´çš„å†…å®¹)
              FRONT_MATTER=$(sed -n '/^---$/,/^---$/{/^---$/!p}' "$file" 2>/dev/null)
              if [ -z "$FRONT_MATTER" ]; then
                echo "âš ï¸ $file æ²¡æœ‰ YAML Front Matter"
                continue
              fi

              # åˆ›å»ºä¸´æ—¶æ–‡ä»¶ç»™ yq ä½¿ç”¨
              TEMP_YAML=$(mktemp)
              echo "$FRONT_MATTER" > "$TEMP_YAML"

              # ğŸš« ä¸ç”¨ Pythonï¼Œæ”¹ç”¨ yq æå–å­—æ®µ
              STATUS=$(yq eval '.status' "$TEMP_YAML" 2>/dev/null)
              TRANSLATING_DATE=$(yq eval '.translating_date' "$TEMP_YAML" 2>/dev/null)

              rm -f "$TEMP_YAML"

              if [ "$STATUS" = "translating" ]; then
                if [ -z "$TRANSLATING_DATE" ]; then
                  echo "âŒ $file: ç¼ºå°‘ translating_date å­—æ®µ"
                  HAS_ERROR=true
                  if [ "$FIRST_ITEM" = true ]; then
                    FIRST_ITEM=false
                  else
                    JSON_LIST="$JSON_LIST,"
                  fi
                  JSON_LIST="$JSON_LIST{\"æ–‡ä»¶\": \"$file\", \"è¶…æœŸ\": \"ç¼ºå°‘æ—¥æœŸå­—æ®µ\", \"PRé“¾æ¥\": \"$PR_URL\"}"

                else
                  # éªŒè¯æ—¥æœŸæ ¼å¼
                  if ! date -d "$TRANSLATING_DATE" "+%Y-%m-%d" >/dev/null 2>&1; then
                    echo "âŒ $file: translating_date æ ¼å¼é”™è¯¯: '$TRANSLATING_DATE'"
                    HAS_ERROR=true
                    if [ "$FIRST_ITEM" = true ]; then
                      FIRST_ITEM=false
                    else
                      JSON_LIST="$JSON_LIST,"
                    fi
                    JSON_LIST="$JSON_LIST{\"æ–‡ä»¶\": \"$file\", \"è¶…æœŸ\": \"æ ¼å¼é”™è¯¯: $TRANSLATING_DATE\", \"PRé“¾æ¥\": \"$PR_URL\"}"

                  else
                    # è®¡ç®—è¶…æœŸå¤©æ•°
                    TRANSLATING_TS=$(date -d "$TRANSLATING_DATE" +%s)
                    TODAY_TS=$(date +%s)
                    DAY_DIFF=$(( (TODAY_TS - TRANSLATING_TS) / 86400 ))

                    if [ $DAY_DIFF -gt 1 ]; then
                      echo "ğŸš¨ $file: translating_date è¶…è¿‡ 1 å¤©ï¼ˆ$DAY_DIFF å¤©å‰ï¼‰"
                      HAS_ERROR=true
                      if [ "$FIRST_ITEM" = true ]; then
                        FIRST_ITEM=false
                      else
                        JSON_LIST="$JSON_LIST,"
                      fi
                      JSON_LIST="$JSON_LIST{\"æ–‡ä»¶\": \"$file\", \"è¶…æœŸ\": \"$DAY_DIFF å¤©å‰ ($TRANSLATING_DATE)\", \"PRé“¾æ¥\": \"$PR_URL\"}"
                    else
                      echo "âœ… $file: translating_date åœ¨ 1 å¤©å†…"
                    fi
                  fi
                fi
              else
                echo "â„¹ï¸ $file: status ä¸æ˜¯ 'translating'ï¼Œè·³è¿‡æ£€æŸ¥"
              fi

            done <<< "$CHANGED_MD_FILES"

            JSON_LIST="$JSON_LIST]"

            # å¦‚æœæœ‰é”™è¯¯ï¼Œå‘é€é£ä¹¦é€šçŸ¥
            if [ "$HAS_ERROR" = true ]; then
              echo "ğŸš¨ æ­¤ PR å­˜åœ¨å…ƒæ•°æ®é—®é¢˜ï¼Œå‡†å¤‡å‘é€é£ä¹¦é€šçŸ¥..."

              # è°ƒç”¨ä½ çš„é£ä¹¦è„šæœ¬ï¼ˆå®ƒä» stdin è¯»å– JSONï¼‰
              echo "$JSON_LIST" | .scripts/feishu.py \
                -t "ğŸš¨ ç¿»è¯‘è¶…æœŸæé†’ [PR #$pr_number]" \
                -H "**ä»¥ä¸‹æ–‡ä»¶ç¿»è¯‘çŠ¶æ€å·²è¶…æœŸï¼Œè¯·åŠæ—¶å¤„ç†**" \
                -c "red"

              echo "âœ… é£ä¹¦é€šçŸ¥å·²å‘é€ã€‚"
            else
              echo "ğŸ‰ æ­¤ PR æ‰€æœ‰ Markdown æ–‡ä»¶å…ƒæ•°æ®ç¬¦åˆè§„èŒƒï¼"
            fi

            echo "------------------------------"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}