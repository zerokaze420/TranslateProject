name: Check PRs for Modified Markdown Files

on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:

permissions:
  pull-requests: read
  contents: read

jobs:
  check-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: List open pull requests
        id: list_prs
        run: |
          PRS=$(gh api --paginate \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/pulls?state=open&per_page=100" \
            --jq '.[].number')

          if [ -z "$PRS" ]; then
            echo "No open PRs found."
            echo "prs=" >> $GITHUB_OUTPUT
          else
            echo "Found PRs: $PRS"
            echo "prs=$PRS" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Process each PR
        if: ${{ steps.list_prs.outputs.prs != '' }}
        run: |
          IFS=$'\n'
          for pr_number in ${{ steps.list_prs.outputs.prs }}; do
            echo "=== Checking PR #$pr_number ==="

            BASE_REF=$(gh api "/repos/${{ github.repository }}/pulls/$pr_number" --jq '.base.ref')
            echo "Base branch: $BASE_REF"

            # 获取 PR 合并预览
            git fetch origin "pull/$pr_number/merge:pr_merge_$pr_number" 2>/dev/null || {
              echo "⚠️ 无法获取 PR 合并预览，可能冲突或尚未准备好。跳过此 PR。"
              continue
            }

            git checkout pr_merge_$pr_number

            # 检查是否修改了 sources/**/*.md
            CHANGED_MD_FILES=$(git diff --name-only "origin/$BASE_REF..HEAD" -- 'sources/**/*.md' 2>/dev/null)

            if [ -n "$CHANGED_MD_FILES" ]; then
              echo "✅ PR #$pr_number 修改了以下 Markdown 文件："
              echo "$CHANGED_MD_FILES"
            else
              echo "❌ PR #$pr_number 未修改 sources/**/*.md 文件"
            fi

            echo "------------------------------"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}