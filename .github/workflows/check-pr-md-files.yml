name: Check PRs for Modified Markdown Files

on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:

permissions:
  pull-requests: read
  contents: read

jobs:
  check-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: List open pull requests
        id: list_prs
        run: |
          PRS=$(gh api --paginate \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/pulls?state=open&per_page=100" \
            --jq '.[].number')
          if [ -z "$PRS" ]; then
            echo "No open PRs found."
            echo "prs=" >> $GITHUB_OUTPUT
          else
            echo "Found PRs: $PRS"
            echo "prs=$PRS" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install yq via APT (from mikefarah/yq official repo)
        run: |
          # ç¡®ä¿ wget å·²å®‰è£…
          sudo apt-get update
          sudo apt-get install -y wget
          # ä¸‹è½½å¹¶å®‰è£…å®˜æ–¹ GPG å¯†é’¥
          sudo wget -O /usr/share/keyrings/yq-archive-keyring.gpg https://mikefarah.github.io/yq/apt.key
          # æ·»åŠ å®˜æ–¹ APT æº
          echo "deb [signed-by=/usr/share/keyrings/yq-archive-keyring.gpg] https://mikefarah.github.io/yq/debian stable main" | sudo tee /etc/apt/sources.list.d/yq.list
          # æ›´æ–°æºå¹¶å®‰è£… yq
          sudo apt-get update
          sudo apt-get install -y yq

      - name: Verify yq installation
        run: |
          yq --version
          # ç¡®ä¿æ˜¯ v4+ï¼ˆmikefarah/yqï¼‰
          yq eval -V

      - name: Process each PR
        if: ${{ steps.list_prs.outputs.prs != '' }}
        run: |
          IFS=$'\n'
          for pr_number in ${{ steps.list_prs.outputs.prs }}; do
            echo "=== Checking PR #$pr_number ==="
            BASE_REF=$(gh api "/repos/${{ github.repository }}/pulls/$pr_number" --jq '.base.ref')
            echo "Base branch: $BASE_REF"

            # è·å– PR åˆå¹¶é¢„è§ˆ
            git fetch origin "pull/$pr_number/merge:pr_merge_$pr_number" 2>/dev/null || {
              echo "âš ï¸ æ— æ³•è·å– PR åˆå¹¶é¢„è§ˆï¼Œå¯èƒ½å†²çªæˆ–å°šæœªå‡†å¤‡å¥½ã€‚è·³è¿‡æ­¤ PRã€‚"
              continue
            }
            git checkout pr_merge_$pr_number

            # æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº† sources/**/*.md
            CHANGED_MD_FILES=$(git diff --name-only "origin/$BASE_REF..HEAD" -- 'sources/**/*.md' 2>/dev/null)
            if [ -z "$CHANGED_MD_FILES" ]; then
              echo "âŒ PR #$pr_number æœªä¿®æ”¹ sources/**/*.md æ–‡ä»¶"
              echo "------------------------------"
              continue
            fi

            echo "âœ… PR #$pr_number ä¿®æ”¹äº†ä»¥ä¸‹ Markdown æ–‡ä»¶ï¼š"
            echo "$CHANGED_MD_FILES"

            # éå†æ¯ä¸ªä¿®æ”¹çš„ Markdown æ–‡ä»¶ï¼Œæ£€æŸ¥å…ƒæ•°æ®
            HAS_ERROR=false
            while IFS= read -r file; do
              if [ ! -f "$file" ]; then
                echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨: $file"
                continue
              fi

              # æå– YAML Front Matter (å‡è®¾æ˜¯ --- å¼€å¤´å’Œç»“å°¾çš„)
              FRONT_MATTER=$(sed -n '/^---$/,/^---$/{/^---$/!p}' "$file" 2>/dev/null)
              if [ -z "$FRONT_MATTER" ]; then
                echo "âš ï¸ $file æ²¡æœ‰ YAML Front Matter"
                HAS_ERROR=true
                continue
              fi

              # åˆ›å»ºä¸´æ—¶ YAML æ–‡ä»¶ä¾› yq è§£æ
              TEMP_YAML=$(mktemp)
              echo "$FRONT_MATTER" > "$TEMP_YAML"

              # æ£€æŸ¥ status å­—æ®µ
              STATUS=$(yq eval '.status' "$TEMP_YAML" 2>/dev/null)
              if [ "$STATUS" != "translating" ]; then
                echo "âŒ $file: status å­—æ®µä¸æ˜¯ 'translating'ï¼Œå½“å‰å€¼: '$STATUS'"
                HAS_ERROR=true
              fi

              # æ£€æŸ¥ translating_date å­—æ®µæ ¼å¼ (YYYY-MM-DD)
              TRANSLATING_DATE=$(yq eval '.translating_date' "$TEMP_YAML" 2>/dev/null)
              if [ -z "$TRANSLATING_DATE" ]; then
                echo "âŒ $file: ç¼ºå°‘ translating_date å­—æ®µ"
                HAS_ERROR=true
              else
                # ä½¿ç”¨ date å‘½ä»¤éªŒè¯æ˜¯å¦ä¸ºåˆæ³• YYYY-MM-DD æ ¼å¼
                if ! date -d "$TRANSLATING_DATE" "+%Y-%m-%d" >/dev/null 2>&1; then
                  echo "âŒ $file: translating_date æ ¼å¼é”™è¯¯ï¼Œåº”ä¸º YYYY-MM-DDï¼Œå½“å‰å€¼: '$TRANSLATING_DATE'"
                  HAS_ERROR=true
                else
                  echo "âœ… $file: translating_date æ ¼å¼æ­£ç¡®: $TRANSLATING_DATE"
                fi
              fi

              rm -f "$TEMP_YAML"
            done <<< "$CHANGED_MD_FILES"

            if [ "$HAS_ERROR" = true ]; then
              echo "ğŸš¨ æ­¤ PR å­˜åœ¨å…ƒæ•°æ®é—®é¢˜ï¼Œè¯·ä¿®æ­£ï¼"
            else
              echo "ğŸ‰ æ­¤ PR æ‰€æœ‰ Markdown æ–‡ä»¶å…ƒæ•°æ®ç¬¦åˆè§„èŒƒï¼"
            fi

            echo "------------------------------"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}