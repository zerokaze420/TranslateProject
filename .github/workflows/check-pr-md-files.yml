# =============================================
# ğŸ“… å·¥ä½œæµåç§°ï¼šæ£€æŸ¥ PR ä¸­çš„ Markdown æ–‡ä»¶ç¿»è¯‘çŠ¶æ€
# âœ… æ¯å¤© UTC 10:00 è‡ªåŠ¨æ‰«æ + æ”¯æŒæ‰‹åŠ¨è§¦å‘
# âœ… æ£€æŸ¥ sources/**/*.md æ˜¯å¦ status: translating ä¸”è¶…æœŸ
# âœ… è¶…æœŸåˆ™é€šè¿‡é£ä¹¦æœºå™¨äººå‘é€æé†’å¡ç‰‡
# =============================================

name: Check PRs for Modified Markdown Files

# ğŸ•’ è§¦å‘æ¡ä»¶
on:
  schedule:
    - cron: '0 10 * * *'  # æ¯å¤© UTC 10:00 æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 18:00ï¼‰
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨åœ¨ Actions é¡µé¢è§¦å‘

# ğŸ” æƒé™æœ€å°åŒ–ï¼ˆåªè¯» PR å’Œä»£ç ï¼‰
permissions:
  pull-requests: read
  contents: read

jobs:
  check-prs:
    runs-on: ubuntu-latest
    steps:

      # ğŸ§± æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç 
      - name: ğŸ” Checkout repository
        uses: actions/checkout@v4

      # ğŸ æ­¥éª¤ 2ï¼šå®‰è£… Python ä¾èµ–ï¼ˆæå‰å®‰è£…ï¼Œé¿å…æ¯æ¬¡å¾ªç¯é‡å¤ï¼‰
      - name: ğŸ Install Python dependencies
        run: |
          pip install requests python-dotenv

      # ğŸ“¦ æ­¥éª¤ 3ï¼šå®‰è£… yqï¼ˆç”¨äºè§£æ YAML Front Matterï¼‰
      - name: ğŸ“¦ Install yq (YAML processor)
        run: |
          wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      # âœ… æ­¥éª¤ 4ï¼šéªŒè¯ yq å®‰è£…
      - name: âœ… Verify yq installation
        run: yq --version

      # ğŸ“‹ æ­¥éª¤ 5ï¼šåˆ—å‡ºæ‰€æœ‰ open PR
      - name: ğŸ“‹ List open pull requests
        id: list_prs
        run: |
          PRS=$(gh api --paginate \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/pulls?state=open&per_page=100" \
            --jq '[.[].number] | join(" ")')
          if [ -z "$PRS" ]; then
            echo "ğŸ“­ æ²¡æœ‰æ‰¾åˆ°ä»»ä½• open PR"
            echo "prs=" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¬ æ‰¾åˆ°ä»¥ä¸‹ PR: $PRS"
            echo "prs=$PRS" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ” æ­¥éª¤ 6ï¼šéå†æ¯ä¸ª PRï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è¶…æœŸæ–‡ä»¶
      - name: ğŸ” Process each PR and send Feishu alert if needed
        if: ${{ steps.list_prs.outputs.prs != '' }}
        run: |
          # ğŸ”„ éå†æ‰€æœ‰ PR ç¼–å·
          for pr_number in ${{ steps.list_prs.outputs.prs }}; do
            echo ""
            echo "=== ğŸš€ æ­£åœ¨æ£€æŸ¥ PR #$pr_number ==="

            # ğŸŒ è·å– PR çš„å®Œæ•´ URL
            PR_URL=$(gh api "/repos/${{ github.repository }}/pulls/$pr_number" --jq '.html_url')
            if [ -z "$PR_URL" ]; then
              PR_URL="https://github.com/${{ github.repository }}/pull/$pr_number"
            fi

            # ğŸŒ¿ è·å–ç›®æ ‡åˆ†æ”¯ï¼ˆbase branchï¼‰
            BASE_REF=$(gh api "/repos/${{ github.repository }}/pulls/$pr_number" --jq '.base.ref')
            echo "ğŸ¯ ç›®æ ‡åˆ†æ”¯: $BASE_REF"

            # ğŸ§¬ è·å– PR åˆå¹¶é¢„è§ˆï¼ˆæ¨¡æ‹Ÿåˆå¹¶åçš„çŠ¶æ€ï¼‰
            git fetch origin "pull/$pr_number/merge:pr_merge_$pr_number" 2>/dev/null || {
              echo "âš ï¸ æ— æ³•è·å– PR åˆå¹¶é¢„è§ˆï¼Œå¯èƒ½å†²çªæˆ–å°šæœªå‡†å¤‡å¥½ã€‚è·³è¿‡æ­¤ PRã€‚"
              continue
            }
            git checkout pr_merge_$pr_number

            # ğŸ“„ æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº† sources/**/*.md
            CHANGED_MD_FILES=$(git diff --name-only "origin/$BASE_REF..HEAD" -- 'sources/**/*.md' 2>/dev/null)
            if [ -z "$CHANGED_MD_FILES" ]; then
              echo "âœ… PR #$pr_number æœªä¿®æ”¹ sources/**/*.md æ–‡ä»¶ï¼Œè·³è¿‡æ£€æŸ¥"
              echo "------------------------------"
              continue
            fi

            echo "ğŸ“ PR #$pr_number ä¿®æ”¹äº†ä»¥ä¸‹ Markdown æ–‡ä»¶ï¼š"
            echo "$CHANGED_MD_FILES"

            # ğŸ§¾ åˆå§‹åŒ– JSON æ•°ç»„ï¼Œç”¨äºæ”¶é›†è¶…æœŸæ–‡ä»¶
            JSON_LIST="["
            HAS_ERROR=false
            FIRST_ITEM=true

            # ğŸ“– é€ä¸ªæ£€æŸ¥æ–‡ä»¶
            while IFS= read -r file; do
              if [ ! -f "$file" ]; then
                echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨: $file"
                continue
              fi

              # ğŸ§¾ æå– YAML Front Matterï¼ˆ--- ä¹‹é—´çš„éƒ¨åˆ†ï¼‰
              FRONT_MATTER=$(sed -n '/^---$/,/^---$/{/^---$/!p}' "$file" 2>/dev/null)
              if [ -z "$FRONT_MATTER" ]; then
                echo "âš ï¸ $file æ²¡æœ‰ YAML Front Matter"
                continue
              fi

              # ğŸ—ƒï¸ åˆ›å»ºä¸´æ—¶ YAML æ–‡ä»¶ä¾› yq è§£æ
              TEMP_YAML=$(mktemp)
              echo "$FRONT_MATTER" > "$TEMP_YAML"

              # ğŸ¯ æå– status å’Œ translating_date
              STATUS=$(yq eval '.status' "$TEMP_YAML" 2>/dev/null)
              TRANSLATING_DATE=$(yq eval '.translating_date' "$TEMP_YAML" 2>/dev/null)
              rm -f "$TEMP_YAML"

              # ğŸ” åªæ£€æŸ¥ status: translating çš„æ–‡ä»¶
              if [ "$STATUS" = "translating" ]; then
                if [ -z "$TRANSLATING_DATE" ]; then
                  echo "âŒ $file: ç¼ºå°‘ translating_date å­—æ®µ"
                  HAS_ERROR=true
                  [ "$FIRST_ITEM" = false ] && JSON_LIST="$JSON_LIST,"
                  JSON_LIST="$JSON_LIST{\"æ–‡ä»¶\": \"$file\", \"è¶…æœŸ\": \"ç¼ºå°‘æ—¥æœŸå­—æ®µ\", \"PRé“¾æ¥\": \"$PR_URL\"}"
                  FIRST_ITEM=false
                else
                  # ğŸ“… éªŒè¯æ—¥æœŸæ ¼å¼
                  if ! date -d "$TRANSLATING_DATE" "+%Y-%m-%d" >/dev/null 2>&1; then
                    echo "âŒ $file: translating_date æ ¼å¼é”™è¯¯: '$TRANSLATING_DATE'"
                    HAS_ERROR=true
                    [ "$FIRST_ITEM" = false ] && JSON_LIST="$JSON_LIST,"
                    JSON_LIST="$JSON_LIST{\"æ–‡ä»¶\": \"$file\", \"è¶…æœŸ\": \"æ ¼å¼é”™è¯¯: $TRANSLATING_DATE\", \"PRé“¾æ¥\": \"$PR_URL\"}"
                    FIRST_ITEM=false
                  else
                    # ğŸ§® è®¡ç®—è¶…æœŸå¤©æ•°
                    TRANSLATING_TS=$(date -d "$TRANSLATING_DATE" +%s)
                    TODAY_TS=$(date +%s)
                    DAY_DIFF=$(( (TODAY_TS - TRANSLATING_TS) / 86400 ))
                    if [ $DAY_DIFF -gt 1 ]; then
                      echo "ğŸš¨ $file: translating_date è¶…è¿‡ 1 å¤©ï¼ˆ$DAY_DIFF å¤©å‰ï¼‰"
                      HAS_ERROR=true
                      [ "$FIRST_ITEM" = false ] && JSON_LIST="$JSON_LIST,"
                      JSON_LIST="$JSON_LIST{\"æ–‡ä»¶\": \"$file\", \"è¶…æœŸ\": \"$DAY_DIFF å¤©å‰ ($TRANSLATING_DATE)\", \"PRé“¾æ¥\": \"$PR_URL\"}"
                      FIRST_ITEM=false
                    else
                      echo "âœ… $file: translating_date åœ¨ 1 å¤©å†…"
                    fi
                  fi
                fi
              else
                echo "â„¹ï¸ $file: status ä¸æ˜¯ 'translating'ï¼Œè·³è¿‡æ£€æŸ¥"
              fi
            done <<< "$CHANGED_MD_FILES"

            JSON_LIST="$JSON_LIST]"

            # ğŸš¨ å¦‚æœæœ‰è¶…æœŸæ–‡ä»¶ï¼Œå‘é€é£ä¹¦é€šçŸ¥
            if [ "$HAS_ERROR" = true ]; then
              echo "ğŸš¨ æ­¤ PR å­˜åœ¨å…ƒæ•°æ®é—®é¢˜ï¼Œå‡†å¤‡å‘é€é£ä¹¦é€šçŸ¥..."

              # âœ… ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
              chmod +x .scripts/feishu.py

              # ğŸ“¤ å‘é€é£ä¹¦å¡ç‰‡ï¼ˆä» stdin ä¼ å…¥ JSONï¼‰
              echo "$JSON_LIST" | .scripts/feishu.py \
                -t "ğŸš¨ ç¿»è¯‘è¶…æœŸæé†’ [PR #$pr_number]" \
                -H "**ä»¥ä¸‹æ–‡ä»¶ç¿»è¯‘çŠ¶æ€å·²è¶…æœŸï¼Œè¯·åŠæ—¶å¤„ç†**" \
                -c "red" \
                --link-fields "PRé“¾æ¥"

              echo "âœ… é£ä¹¦é€šçŸ¥å·²å‘é€ã€‚"
            else
              echo "ğŸ‰ æ­¤ PR æ‰€æœ‰ Markdown æ–‡ä»¶å…ƒæ•°æ®ç¬¦åˆè§„èŒƒï¼"
            fi

            echo "------------------------------"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # âœ… å…³é”®ä¿®æ­£ï¼šæ³¨å…¥æ­£ç¡®çš„ç¯å¢ƒå˜é‡åç»™ Python è„šæœ¬ä½¿ç”¨
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}